이 글은 (주)넥스트스텝의 류성현 강사님이 진행하시는 ATDD, 클린 코드 with Spring 강의 자료를 정리한 내용입니다.

강의 링크: (https://edu.nextstep.camp/s/c30VOHNP)

--- 

### 1주차 강의내용
> TDD는 단위 테스트를 기반으로 소프트웨어를 개발하는 프로세스이다.

#### (User) Acceptance Test
> 사용자 인수테스트는 공개 API를 통해 제품을 조작하면서 특정 사용자 여정이 의도한 대로 이루어지는지를 보장하는 테스트이다. (구글 엔지니어는 이렇게 일한다 중)


#### TDD vs ATDD
 - TDD: 작은 단위의 요구사항을 테스트한다.
 - ATDD: 시나리오 형태의 요구사항을 테스트한다.

---

### ATDD를 하는 이유


#### 생산성 증가
 - 구현전에 인수 테스트를 수행하는 경우 팀의 생산성이 올라간다.
 - 작업의 명확한 시작과 끝을 제시한다.
 - TDD의 부족한 부분을 보완 가능하다.
 - 구현한 기능을 배포하지 않고 테스트로 확인 가능하다.
 - 귀찮은 작업 프로세스로 강제한다.
    * 테스트 코드 작성과 문서화는 귀찮은 작업
    * 전체 기능을 검증하는 테스트가 만들어진다.
    * 회기 테스트 역할을 수행한다.
    * 회기테스트: 이미 테스트된 프로그램의 테스팅을 반복하는 것으로, 결함 수정 이후 변경의 결과로 새롭게 만들어 지거나, 이전 결함으로 인해 발견되지 않았던 또 다른 결함을 발견하는 테스트이다.
  
#### 인수테스트란?
 - 사용자 스토리를 검증하는 기능 테스트이다.
 - 사용자 스토리로 테스트할 시나리오를 지정한다.
  
  

#### 이번 과정에서의 인수 테스트
 - 백엔드 개발자가 단독적으로 적용해서 실천해볼 수 있는 범위
 - 고객은 프론트엔드 개발자 혹은 API 활용하는 사람 대상이다.
 - API 접점에서 검증하는 E2E 테스트이다.
 - API의 Request와 Response 정보 이외 내부 정보는 최대한 가리는 블랙박스 형식의 테스트이다.
 
---
### 인수 테스트 만들기 전 알아야 할것


블랙 박스 테스트
: 인수테스트는 블랙 박스 테스트의 성격을 가지고 있다.

#### 블랙박스
- 클라이언트는 결과물의 내부 구현이나 사용된 기술을 기반으로 검증하기 보다는 표면적으로 확인할 수 있는 요소를 바탕으로 검증하려 한다.
- 실제 사용하는 상황의 시나리오를 바탕으로 요구사항을 작성한다. 
- 내부구현이나 기술에 의존적이지 않는 블랙박스 테스트이다.


E2E 테스트
: API레벨의 블랙박스 테스트이므로 요청과 응답 기준으로 API레벨의 E2E 테스트로 검증한다.

---

### 인수 테스트 도구 설명

@Spring Boot Test
: 테스트에 사용할 ApplicationContext를 쉽게 지정하게 도와준다.  
 SpringApplication에서 사용하는 ApplicationContext를 생성해서 작동한다.

@RestAssured
: REST-assured는 REST API의 테스트 및 검증을 단순화하도록 설계
 HTTP 작업에 대한 검증을 풍부한 API를 활용가능하다.

---

### 1주차 피드백

#### 인수테스트 격리하기

#### 1. @Transactional
 - RANDOM_PORT나 DEFINED_PORT 사용할 경우 실제 서블릿 환경이 제공된다.
 - HTTP Client와 Server는 다른 스레드에서 동작한다.
 - 따라서 @Transactional을 통한 roll back은 동작하지 않는다.

#### 2. @DirtiesContext
- 효과적인 테스트 수행을 위해 스프링에서는 context caching 기능 지원
- context caching의 조건이 빈이 오염되지 않은 경우
- @DirtiesContext를 활용하여(빈을 오염시켜) 캐시 기능을 사용하지 않게 설정 가능
- 매번 COntext를 새로 구성하다보니 시간이 많이 걸린다.

#### 3. @Sql 혹은 쿼리 수행
- 테스트가 수행될 때마다 테이블들을 truncate 시키는 쿼리 수행
- 컨텍스트를 다시 띄우는 것보다 낮은 비용
- 테이블이 추가될 때마다 해당 쿼리 수정이 필요하다.

#### 4. 코드 상으로 테이블 truncate
- JPA 사용시 EntityManager를 이용하여 테이블 이름 조회
- 아닌 경우 DataSource를 이용하여 테이블 이름 조회
- 각 테이블을 truncate 시켜주는 쿼리 수행
- 테이블 상태에 의존하지 않는 초기화 환경 구축 가능.

---

#### 인수테스트 리팩토링
- 테스트의 의도를 명확히 드러내기
- 테스트 가독성이 중요한 이유
- 가독성이 좋지 않으면 방치되는 테스트가 될 가능성이 높다.
- 변경 사항에 대해서 수정하기 어렵다. -> 방치될 가능성이 높다.
- @Ignore or @Disabled
- 가독성이 좋으면 해당 기능의 스펙을 나타낼 수 있다.

프로덕션 코드의 가독성이 중요한 만큼 테스트 코드의 가독성도 중요하다.

#### 테스트 코드 중복 제거
- 기능 개발 간 테스트 코드도 중복이 많이 발생한다.
- 테스트 가독성을 저해하는 구조가 나올 수 있어 중복제거가 중요하다.
- 가독성이 좋지 않은 테스트코드는 관리가 되지 않는 가능성이 높다.

#### 중복 제거 방법
- 메서드 분리
- CRUD 추상화
- Cucumber나 JBehave와 같은 BDD 도구 사용

1. 메서드 분리  
   반복되는 코드는 메서드로 분리한다.  
   ex) StationAcceptanceTest

2. 의도 드러내기  
   테스트의 각 스텝을 한글 메서드로 분류한다.  
   ex)각 요청에 대한 응답

3. 다른 인수 테스트에서 재사용
   스텝 메서드들을 static 선언, 스텝 메서드를 모아놓은 별도의 클래스로 분리한다.

 